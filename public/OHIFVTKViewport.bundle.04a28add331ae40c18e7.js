(window.webpackJsonp=window.webpackJsonp||[]).push([[7,8],{1011:function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),o=n(121),i=n(14),s=n(58),c=n(1),u=n.n(c),l=n(434);n(959);function p(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function f(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){p(o,r,a,i,s,"next",e)}function s(e){p(o,r,a,i,s,"throw",e)}i(void 0)}))}}var d=Object(l.a)(f(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(o.a)();case 2:return t=e.sent,e.abrupt("return",{default:t.View2D});case 4:case"end":return e.stop()}}),e)})))),m=function(e){var t=Object(r.useCallback)((function(){var t=e.setViewportActive;e.viewportIndex!==e.activeViewportIndex&&t()}));return Object(r.useEffect)((function(){var n=function(n){(e.onScroll(e.viewportIndex)||{}).uid===n.detail.uid&&t()};return window.addEventListener("vtkscrollevent",n),function(){return window.removeEventListener("vtkscrollevent",n)}}),[e,e.onScroll,e.viewportIndex,t]),a.a.createElement("div",{className:"vtk-viewport-handler",style:{width:"100%",height:"100%",position:"relative"},onClick:t},a.a.createElement(d,e))};m.propTypes={setViewportActive:u.a.func.isRequired,viewportIndex:u.a.number.isRequired,activeViewportIndex:u.a.number.isRequired,onScroll:u.a.func},m.defaultProps={onScroll:function(){}};var v=m;function y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function b(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?y(Object(n),!0).forEach((function(t){g(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):y(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=i.a.redux.actions,w=h.setViewportActive,I=h.setViewportSpecificData,O=Object(s.b)((function(e,t){var n;e.extensions&&e.extensions.vtk&&(n=e.extensions.vtk);var r=t.viewportIndex,a=r===e.viewports.activeViewportIndex,o=e.viewports.layout.viewports[r].vtk||{};return b({activeViewportIndex:e.viewports.activeViewportIndex,layout:e.viewports.layout,isActive:a},o,{},n,{enableStackPrefetch:a})}),(function(e,t){var n=t.viewportIndex;return{setViewportActive:function(){e(w(n))},setViewportSpecificData:function(t){e(I(n,t))}}}),(function(e,t,n){var r=e.afterCreation;return b({},e,{},t,{},n,{onCreated:function(e){r&&"function"==typeof r&&r(e)}})}))(v),D=(n(960),n(30));function S(e){return(S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function j(e,t){return!t||"object"!==S(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function x(e){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function C(e,t){return(C=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(e){function t(){return P(this,t),j(this,x(t).apply(this,arguments))}var n,r,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&C(e,t)}(t,e),n=t,(r=[{key:"render",value:function(){var e;return this.props.percentComplete&&100!==this.props.percentComplete&&(e="".concat(this.props.percentComplete,"%")),a.a.createElement(a.a.Fragment,null,this.props.error?a.a.createElement("div",{className:"imageViewerErrorLoadingIndicator loadingIndicator"},a.a.createElement("div",{className:"indicatorContents"},a.a.createElement("h4",null,"Error Loading Image"),a.a.createElement("p",{className:"description"},"An error has occurred."),a.a.createElement("p",{className:"details"},this.props.error.message))):a.a.createElement("div",{className:"imageViewerLoadingIndicator loadingIndicator"},a.a.createElement("div",{className:"indicatorContents"},a.a.createElement("p",null,this.props.t("Reformatting"),"...",a.a.createElement("i",{className:"fa fa-spin fa-circle-o-notch fa-fw"}),e))))}}])&&k(n.prototype,r),o&&k(n,o),t}(r.PureComponent);E(T,"propTypes",{percentComplete:u.a.number.isRequired,error:u.a.object}),E(T,"defaultProps",{percentComplete:0,error:null});var U=Object(D.d)("Common")(T),V=n(5),L=n.n(V),R=n(7),F=n.n(R),_=n(862),N=n(887),A=n(931),M=n(914);function B(e){return(B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function q(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function H(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){q(o,r,a,i,s,"next",e)}function s(e){q(o,r,a,i,s,"throw",e)}i(void 0)}))}}function K(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function J(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function G(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function W(e,t){return!t||"object"!==B(t)&&"function"!=typeof t?Q(e):t}function z(e){return(z=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Q(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function X(e,t){return(X=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Z=F.a.getModule("segmentation"),$=i.a.utils.StackManager,ee={},te={},ne=function(e){function t(){var e,n;J(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return Y(Q(n=W(this,(e=z(t)).call.apply(e,[this].concat(a)))),"state",{volumes:null,paintFilterLabelMapImageData:null,paintFilterBackgroundImageData:null}),Y(Q(n),"getViewportData",(function(e,n,r,a,o,i,s){var c,u,l=t.getCornerstoneStack(e,n,r,a,o,i),p=s.getImageData(l.imageIds,r),f=l.imageIds[0],d=Z.state,m=d.series[f];if(m){var v=m.activeLabelmapIndex,y=m.labelmaps3D[v],b="".concat(f,"_").concat(v);if(te[b])c=te[b];else{var g,h,w,I,O=y.buffer;c=N.default.newInstance();var D=_.default.newInstance({numberOfComponents:1,values:new Uint16Array(O)});c.getPointData().setScalars(D),(g=c).setDimensions.apply(g,K(p.dimensions)),(h=c).setSpacing.apply(h,K(p.vtkImageData.getSpacing())),(w=c).setOrigin.apply(w,K(p.vtkImageData.getOrigin())),(I=c).setDirection.apply(I,K(p.vtkImageData.getDirection())),te[b]=c}u=d.colorLutTables[y.colorLUTIndex]}return{imageDataObject:p,labelmapDataObject:c,labelmapColorLUT:u}})),n}var n,r,i,s,c,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&X(e,t)}(t,e),n=t,r=[{key:"getOrCreateVolume",value:function(e,t){if(ee[t])return ee[t];var n=e.vtkImageData,r=e.imageMetaData0,a=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if("PT"===n)return{lower:0,upper:5};var r=isNaN(t)||isNaN(e);return r?{lower:0,upper:512}:{lower:t-e/2,upper:t+e/2}}(r.windowWidth,r.windowCenter,r.modality),o=a.lower,i=a.upper,s=A.default.newInstance(),c=M.default.newInstance();s.setMapper(c),c.setInputData(n),s.getProperty().getRGBTransferFunction(0).setRange(o,i);var u=n.getSpacing(),l=(u[0]+u[1]+u[2])/6;return c.setSampleDistance(l),c.setMaximumSamplesPerRay(4e3),ee[t]=s,s}},{key:"setStateFromProps",value:(u=H(regeneratorRuntime.mark((function e(){var t,n,r,a,i,s,c,u,l,p,f,d,m,v,y,b,g=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(o.a)();case 2:t=e.sent,n=this.props.viewportData,r=n.studies,a=n.displaySet,i=a.StudyInstanceUID,s=a.displaySetInstanceUID,c=a.sopClassUIDs,u=a.SOPInstanceUID,l=a.frameIndex,c.length>1&&console.warn("More than one SOPClassUID in the same series is not yet supported."),p=r.find((function(e){return e.StudyInstanceUID===i})),f={studyDate:p.studyDate,studyTime:p.studyTime,studyDescription:p.studyDescription,patientName:p.patientName,patientId:p.patientId,seriesNumber:String(a.seriesNumber),seriesDescription:a.seriesDescription},d=this.getViewportData(r,i,s,c[0],u,l,t),m=d.imageDataObject,v=d.labelmapDataObject,y=d.labelmapColorLUT,this.imageDataObject=m,b=this.getOrCreateVolume(m,s),this.setState({percentComplete:0,dataDetails:f},(function(){g.loadProgressively(m,t),setTimeout((function(){g.setState({volumes:[b],paintFilterLabelMapImageData:v,paintFilterBackgroundImageData:m.vtkImageData,labelmapColorLUT:y})}),200)}));case 12:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"componentDidMount",value:(c=H(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.setStateFromProps();case 2:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"componentDidUpdate",value:(s=H(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.props.viewportData.displaySet,r=t.viewportData.displaySet,n.displaySetInstanceUID===r.displaySetInstanceUID&&n.SOPInstanceUID===r.SOPInstanceUID&&n.frameIndex===r.frameIndex){e.next=5;break}return e.next=5,this.setStateFromProps();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"loadProgressively",value:function(e,t){var n=this;t.loadImageData(e);var r=e.isLoading,a=e.insertPixelDataPromises,o=a.length;r?(a.forEach((function(e){e.then((function(e){var t=Math.floor(100*e/o);t!==n.state.percentComplete&&n.setState({percentComplete:t})}))})),Promise.all(a).then((function(){n.setState({isLoaded:!0})}))):this.setState({isLoaded:!0})}},{key:"render",value:function(){var e=this,t=null,n=Z.configuration;this.props.children&&this.props.children.length&&(t=this.props.children.map((function(t,n){return t&&a.a.cloneElement(t,{viewportIndex:e.props.viewportIndex,key:n})})));var r=n.renderFill||n.renderOutline,o=n.fillAlpha,i=n.outlineThickness;return a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{style:{width:"100%",height:"100%",position:"relative"}},!this.state.isLoaded&&a.a.createElement(U,{percentComplete:this.state.percentComplete}),this.state.volumes&&a.a.createElement(O,{volumes:this.state.volumes,paintFilterLabelMapImageData:this.state.paintFilterLabelMapImageData,paintFilterBackgroundImageData:this.state.paintFilterBackgroundImageData,viewportIndex:this.props.viewportIndex,dataDetails:this.state.dataDetails,labelmapRenderingOptions:{colorLUT:this.state.labelmapColorLUT,globalOpacity:o,visible:r,outlineThickness:i,renderOutline:!0},onScroll:this.props.onScroll})),")}",t)}}],i=[{key:"init",value:function(){console.log("OHIFVTKViewport init()")}},{key:"destroy",value:function(){console.log("OHIFVTKViewport destroy()"),$.clearStacks()}},{key:"getCornerstoneStack",value:function(e,t,n,r,a){var o=e.find((function(e){return e.StudyInstanceUID===t})),i=o.displaySets.find((function(e){return e.displaySetInstanceUID===n})),s=$.findOrCreateStack(o,i),c=Object.assign({},s);if(void 0!==a)c.currentImageIdIndex=a;else if(r){var u=c.imageIds.findIndex((function(e){return L.a.metaData.get("SOPInstanceUID",e)===r}));u>-1&&(c.currentImageIdIndex=u)}else c.currentImageIdIndex=0;return c}}],r&&G(n.prototype,r),i&&G(n,i),t}(r.Component);Y(ne,"propTypes",{viewportData:u.a.shape({studies:u.a.array,displaySet:u.a.shape({StudyInstanceUID:u.a.string,displaySetInstanceUID:u.a.string,sopClassUIDs:u.a.arrayOf(u.a.string),SOPInstanceUID:u.a.string,frameIndex:u.a.number})}),viewportIndex:u.a.number,children:u.a.node,onScroll:u.a.func}),Y(ne,"defaultProps",{onScroll:function(){}}),Y(ne,"id","OHIFVTKViewport");t.default=ne},908:function(e,t){},959:function(e,t,n){},960:function(e,t,n){}}]);
//# sourceMappingURL=OHIFVTKViewport.bundle.04a28add331ae40c18e7.js.map